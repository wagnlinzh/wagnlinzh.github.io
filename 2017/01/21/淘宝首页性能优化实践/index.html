<!DOCTYPE html>
<html>
    <head>
    <!-- Title -->
    
    <title>
        淘宝首页性能优化实践 | wanglinzhizhi
    </title>
    
    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" sizes="192x192" href="/img/favicon.png">
    <link rel="apple-touch-icon" href="/img/favicon.png">
    
    <!-- Meta & INfo -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#0097A7">
    <meta name="author" content="wanglinzhizhi">
    <meta name="description" content="游走在上下文无关文法间">
    <meta name="keywords" content="null">
    
    <!--iOS -->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-title" content="Title">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="480">
    
    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="wanglinzhizhi">
    
    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://www.wanglinzhizhi.me">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="淘宝首页性能优化实践 | wanglinzhizhi">
    <meta property="og:description" content="游走在上下文无关文法间">
    
     <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">
        
        
            <script src="/js/ie-blocker.en.js"></script>
        
    <![endif]-->
    
    <!-- Import CSS -->
    <link rel="stylesheet" href="/css/material.min.css">
    <link rel="stylesheet" href="/css/style.min.css">
    <!-- Config CSS -->


<!-- Other Styles -->
<style>
	body, html{
		font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
	}
	
    a{
        color: #00838F
    }
    
    .mdl-card__media,
    #search-label,
    #search-form-label:after,
    #scheme-Paradox .hot_tags-count,
    #scheme-Paradox .sidebar_archives-count,
    #scheme-Paradox .sidebar-colored .sidebar-header,
    #scheme-Paradox .sidebar-colored .sidebar-badge{
        background-color: #0097A7 !important
    }
    
	/* Sidebar User Drop Down Menu Text Color */
	#scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
    #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus{
        color: #0097A7 !important
    }
    
    #post_entry-right-info,
    .sidebar-colored .sidebar-nav li:hover > a,
    .sidebar-colored .sidebar-nav li:hover > a i,
    .sidebar-colored .sidebar-nav li > a:hover,
    .sidebar-colored .sidebar-nav li > a:hover i,
    .sidebar-colored .sidebar-nav li > a:focus i,
    .sidebar-colored .sidebar-nav > .open > a,
    .sidebar-colored .sidebar-nav > .open > a:hover,
    .sidebar-colored .sidebar-nav > .open > a:focus,
    #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a{
        color: #0097A7 !important
    }
    
    .toTop{
        background: #757575 !important
    }
		
	.material-layout .material-post>.material-nav,
	.material-layout .material-index>.material-nav,
	.material-nav a{
		color: #757575;
	}
		
	#scheme-Paradox .MD-burger-layer {
		background-color: #757575;
	}

	#scheme-Paradox #post-toc-trigger-btn{
		color: #757575;
	}
	
	.post-toc a:hover{
		color: #00838F;
		text-decoration: underline;
	}
</style>


<!-- Theme Background Related-->

    <style>
        body{
            background-color: #F5F5F5
        }
		
		/* blog_info bottom background */
        #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
            background-color: #fff;
        }
    </style>




<!-- Fade Effect -->

    <style>
        .fade {
            transition: all 800ms linear;
            -webkit-transform: translate3d(0,0,0);
            -moz-transform: translate3d(0,0,0);
            -ms-transform: translate3d(0,0,0);
            -o-transform: translate3d(0,0,0);
            transform: translate3d(0,0,0);
            opacity: 1;
        }

        .fade.out{
            opacity: 0;
        }
    </style>

	<script src="/js/jquery.min.js"></script>
	
	<link rel="stylesheet" href="/css/highlight/atom-one-dark.css">
	
	<!-- UC Browser Compatible-->
	<script>
		var agent = navigator.userAgent.toLowerCase();
		if(agent.indexOf('ucbrowser')>0) {
			document.write('<link rel="stylesheet" href="/css/uc.css">');
		   alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
		}
	</script>
    
    <!-- Custom Head -->
    
</head>
	
	

    <body id="scheme-Paradox">

		
        <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
				
			
			
            <!-- Main Container -->
            <main class="material-layout__content" id="main">
				
                <!-- Top Anchor -->
                <div id="top"></div>
				
				
                <!-- Hamburger Button -->
                <button class="MD-burger-icon sidebar-toggle">
                    <span class="MD-burger-layer"></span>
                </button>
				
				
                <!-- Post TOC -->

    
	<!-- Back Button -->
<!--
	<div class="material-back" id="backhome-div" tabindex="0">
		<a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" href="#" onclick="window.history.back();return false;" target="_self" role="button" data-upgraded=",MaterialButton,MaterialRipple">
			<i class="material-icons" role="presentation">arrow_back</i>
			<span class="mdl-button__ripple-container">
				<span class="mdl-ripple"></span>
			</span>
		</a>
	</div>			
-->
	<!-- Left aligned menu below button -->
	<button id="post-toc-trigger-btn"
			class="mdl-button mdl-js-button mdl-button--icon">
	  <i class="material-icons">format_list_numbered</i>
	</button>

	<ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect"
		for="post-toc-trigger-btn">
			
			<ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#淘宝首页性能优化实践"><span class="post-toc-number">1.</span> <span class="post-toc-text">淘宝首页性能优化实践</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#网页性能衡量指标"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">网页性能衡量指标</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#FPS"><span class="post-toc-number">1.1.1.</span> <span class="post-toc-text">FPS</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#DOMContentLoaded-和-Load"><span class="post-toc-number">1.1.2.</span> <span class="post-toc-text">DOMContentLoaded 和 Load</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#流畅度"><span class="post-toc-number">1.1.3.</span> <span class="post-toc-text">流畅度</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#淘宝首页的性能优化"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">淘宝首页的性能优化</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#关键模块优先"><span class="post-toc-number">1.2.1.</span> <span class="post-toc-text">关键模块优先</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#懒执行，有交互才执行"><span class="post-toc-number">1.2.2.</span> <span class="post-toc-text">懒执行，有交互才执行</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#更懒的执行，刷新页面才执行"><span class="post-toc-number">1.2.3.</span> <span class="post-toc-text">更懒的执行，刷新页面才执行</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#图片尺寸的控制和懒加载"><span class="post-toc-number">1.2.4.</span> <span class="post-toc-text">图片尺寸的控制和懒加载</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#模块去钩子，走配置"><span class="post-toc-number">1.2.5.</span> <span class="post-toc-text">模块去钩子，走配置</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#低频修改模块，缓存请求"><span class="post-toc-number">1.2.6.</span> <span class="post-toc-text">低频修改模块，缓存请求</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#使用缓动效果减少等待的焦急感"><span class="post-toc-number">1.2.6.1.</span> <span class="post-toc-text">使用缓动效果减少等待的焦急感</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#优化的思考角度"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">优化的思考角度</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#小结"><span class="post-toc-number">1.4.</span> <span class="post-toc-text">小结</span></a></li></ol></li></ol>
		
<!--			<li class="mdl-menu__item">Some Action</li>-->
	</ul>



<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">
		
        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
	<!-- Paradox Post Header -->
	
		
			<!-- Random Thumbnail -->
			<div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
				<script>
    
    var randomNum;
    randomNum = Math.floor(Math.random() * 5 + 1);
    
    $(".post_thumbnail-random").css('background-image', 'url(' + '/img/random/' + randomNum + '.png' + ')');
    
</script>

		
	
        <p class="article-headline-p">
            淘宝首页性能优化实践
        </p>
    </div>

	

				
				
					<!-- Paradox Post Info -->
					<div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">
    
    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/me.jpeg" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>wanglinzhizhi</strong>
        <span>Jan 21, 2017</span>
    </div>
    
    <div class="section-spacer"></div>
	
    <!-- Favorite -->
<!--
    <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
        <i class="material-icons" role="presentation">favorite</i>
        <span class="visuallyhidden">favorites</span>
    </button>
-->
    
    <!-- Tags (bookmark) -->
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        <a class="post_tag-link" href="/tags/优化实践/">优化实践</a></li><li class="mdl-menu__item"><a class="post_tag-link" href="/tags/性能优化/">性能优化</a>
    </ul>
    
    <!-- Share -->
    <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    
    
    <!-- Leancloud Views -->
    <a class="post_share-link" href="#">
        <li class="mdl-menu__item">
            <span id="/2017/01/21/淘宝首页性能优化实践/" class="leancloud-views_num" data-flag-title="淘宝首页性能优化实践">
     &nbsp;浏览量
</span>
        </li>
    </a>
    
    
    
    
    <!-- Share Twitter -->
    <a class="post_share-link" href="https://twitter.com/intent/tweet?text=淘宝首页性能优化实践&url=http://www.wanglinzhizhi.me//2017/01/21/淘宝首页性能优化实践/index.html&via=wanglinzhizhi" target="_blank">
        <li class="mdl-menu__item">
            分享到 Twitter
        </li>
    </a>
    
    <!-- Share Google+ -->
    <a class="post_share-link" href="https://plus.google.com/share?url=http://www.wanglinzhizhi.me//2017/01/21/淘宝首页性能优化实践/index.html" target="_blank">
        <li class="mdl-menu__item">
            分享到 Google+
        </li>
    </a>
    
    <!-- Share Weibo -->
    <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=淘宝首页性能优化实践&url=http://www.wanglinzhizhi.me//2017/01/21/淘宝首页性能优化实践/index.html&pic=&searchPic=false&style=simple" target="_blank">
        <li class="mdl-menu__item">
            分享到微博
        </li>
    </a>
</ul>
</div>
				

                <!-- Post Content -->
                <div id="post-content" class="markdown-Github mdl-color-text--grey-700 mdl-card__supporting-text fade out">
	
		<h1 id="淘宝首页性能优化实践"><a href="#淘宝首页性能优化实践" class="headerlink" title="淘宝首页性能优化实践"></a>淘宝首页性能优化实践</h1><p>作者: 阎王 发表于: <a href="http://taobaofed.org/blog/2016/04/05/optimize-in-tbhome/" target="_blank" rel="external">2016-04-05</a></p>
<p><img src="https://img.alicdn.com/tps/TB1QzViMpXXXXXZXXXXXXXXXXXX-900-500.jpg" alt="淘宝首页性能优化实践"></p>
<p>想必很多人都已经看到了新版的淘宝首页，它与以往不太一样，这一版页面中四处弥散着个性化的味道，由于独特的个性化需求，前端也面临各方面的技术挑战：</p>
<ul>
<li>数据来源多</li>
<li>串行请求渲染一个模块</li>
<li>运营数据和个性化数据匹配和管理</li>
<li>数据兜底容灾</li>
</ul>
<p>本次淘宝首页改版，虽已不再支持 IE6 和 IE7 等低版本的古董浏览器，但依然存在多个影响首页性能的因素：</p>
<ul>
<li><strong>依赖系统过多</strong>，数据的请求分为三块，其一是静态资源（如 js/css/image/iconfont 等）；其二是推到 CDN 的静态数据（如运营填写的数据、前端配置信息等）；其三是后端接口，不同的模块对应不同的业务，而且页面中还有不少的广告内容，粗略估计页面刚加载时首屏发出的接口请求就有 8 个，滚到最底下，得发出 20 多个请求。</li>
<li><strong>无法直接输出首屏数据</strong>，首屏很多数据是通过异步请求获取的，由于系统限制，这些请求不可避免，而且请求个数较多，十分影响首屏时间。</li>
<li><strong>模块过多</strong>，为了能够在后台隔离运营之间填写数据的权限，模块必须做细粒度的拆分，如下图所示：<br><img src="http://gtms01.alicdn.com/tps/i1/TB1W6IyLVXXXXbQaXXXvLv21FXX-1846-1074.png_800x800.jpg" alt="多模块的拆分"><br>一个简单的模块必须拆分成多个行业小模块，页面中其他位置也是如此，而且这些被拆分出来的模块还不一定会展现出来，需要让算法告诉前端展示哪些模块。</li>
<li><strong>图片过多</strong>，翻页往下滚动，很明显看到，页面整屏整屏的图片，有些图片是运营填写，有些图片由个性化接口提供，这些图片都没有固定的尺寸。</li>
</ul>
<h2 id="网页性能衡量指标"><a href="#网页性能衡量指标" class="headerlink" title="网页性能衡量指标"></a>网页性能衡量指标</h2><p>网页性能衡量指标有很多，倘若能够把握关键的几个，集中优化，性能自然也就上去了。</p>
<h3 id="FPS"><a href="#FPS" class="headerlink" title="FPS"></a>FPS</h3><p>最能反映页面性能的一个指标是 FPS（frame per second），一般系统设定屏幕的刷新率为 60fps，当页面元素动画、滚动或者渐变时绘制速率小于 60，就会不流畅，小于 24 就会卡顿，小于 12 基本认定卡爆了。</p>
<p>1 帧的时长约 16ms，除去系统上下文切换开销，每一帧中只留给我们 10ms 左右的程序处理时间，如果一段脚本的处理时间超过 10ms，那么这一帧就可以被认定为丢失，如果处理时间超过 26ms，可以认定连续两帧丢失，依次类推。我们不能容忍页面中多次出现连续丢失五六帧的情况，也就是说必须想办法分拆执行时间超过 80ms 的代码程序，这个工作并不轻松。</p>
<p>页面在刚开始载入的时候，需要初始化很多程序，也可能有大量耗时的 DOM 操作，所以前 1s 的必要操作会导致帧率很低，我们可以忽略。当然，这是对 PC 而言，Mobile 内容少，无论是 DOM 还是 JS 脚本量都远小于 PC，1s 可能就有点长了。</p>
<h3 id="DOMContentLoaded-和-Load"><a href="#DOMContentLoaded-和-Load" class="headerlink" title="DOMContentLoaded 和 Load"></a>DOMContentLoaded 和 Load</h3><p>DOM 加载并且解析完成才会触发 DOMContentLoaded 事件，倘若源码输出的内容过多，客户端解析 DOM 的时间也会响应加长，不要小看这里的解析时间，如果 DOM 数量增加 2000 个并且嵌套层级较深，解析时间也会相应增加 50-200ms，这个消耗对大多数页面来说其实是没必要的，保证首屏输出即可，后续的内容只保留钩子，利用 JS 动态渲染。</p>
<p>Load 时间可以用来衡量首屏加载中，客户端接受的信息总量，如果在首屏中充满了大尺寸图片或者客户端与后端建立连接次数较多，Load 时间也会相应被拖长。</p>
<h3 id="流畅度"><a href="#流畅度" class="headerlink" title="流畅度"></a>流畅度</h3><p>流畅度是对 FPS 的视觉反馈，FPS 值越高，视觉呈现越流畅。为了保障页面的加载速度，很多内容不会在页面打开的时候全部加载到客户端。这里提到的流畅度是等待过程中的视觉缓冲，如下方是 Google Plus 页面的一个效果图：</p>
<p><img src="http://gtms04.alicdn.com/tps/i4/TB1CbQPLVXXXXauXFXXIrP49pXX-446-537.gif" alt="Google Plus Item"></p>
<p>墙内访问 google 的速度不是很快，上面元素中的的很多内容都是通过异步方式加载，而从上图可以看出 Google 并没有让用户产生等待的焦虑感。</p>
<h2 id="淘宝首页的性能优化"><a href="#淘宝首页的性能优化" class="headerlink" title="淘宝首页的性能优化"></a>淘宝首页的性能优化</h2><p>由于平台限制，淘宝首页面临一个先天的性能缺陷，首屏的渲染需要从 7 个不同的后端取数据，这些数据请求是难以合并的，如果用户屏幕比较大，则首屏的面积也比较大，对应的后端平台数据接口就更多。数据是个性化内容或者为广告内容，故请求也不能缓存。</p>
<h3 id="关键模块优先"><a href="#关键模块优先" class="headerlink" title="关键模块优先"></a>关键模块优先</h3><p>不论用户首屏的面积有多大，<strong>保证关键模块优先加载</strong>。下面代码片段是初始化所有模块的核心部分：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$(&apos;.J_Module&apos;).each(function(mod) &#123;</div><div class="line">  var $mod = $(mod);</div><div class="line">  var name = $mod.attr(&apos;tms&apos;);</div><div class="line">  var data = $mod.attr(&apos;tms-data&apos;);</div><div class="line">  if($mod.hasClass(&apos;tb-pass&apos;)) &#123;</div><div class="line">    Reporter.send(&#123;</div><div class="line">      msg: &quot;跳过模块 &quot; + name</div><div class="line">    &#125;);</div><div class="line">    return;</div><div class="line">  &#125;</div><div class="line">  // 保证首屏模块先加载</div><div class="line">  if (/promo|tmall|tanx|notice|member/.test(name)) &#123;</div><div class="line">    window.requestNextAnimationFrame(function()&#123;</div><div class="line">      // 最后一个参数为 Force, 强制渲染, 不懒加载处理</div><div class="line">      new Loader($mod, data, /tanx/.test(name));</div><div class="line">    &#125;);</div><div class="line">  &#125; else &#123;</div><div class="line">    // 剩下的模块进入懒加载队列</div><div class="line">    lazyQueue.push(&#123;</div><div class="line">      $mod: $mod,</div><div class="line">      data: data,</div><div class="line">      force: /fixedtool|decorations|bubble/.test(name)</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>TMS 输出的模块都会包含一个 <code>.J_Module</code> 钩子，并且会预先加载 js 和 css 文件。</p>
<p>对于无 JS 内容的模块，会预先打上 <code>tb-pass</code> 的标记，初始化的时候跳过此模块；对于首屏模块关键模块，会直接进入懒加载监控：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">// $box 进入浏览器视窗后渲染</div><div class="line">// new Loader($box, data) -&gt;</div><div class="line">datalazyload.addCallback($box, function() &#123;</div><div class="line">  self.loadModule($box, data);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">// $box 立即渲染</div><div class="line">// new Loader($box, data, true) -&gt;</div><div class="line">self.loadModule($box, data);</div></pre></td></tr></table></figure>
<p>除必须立即加载的模块外，关键模块被加到懒加载监控，原因是，部分用户进入页面就可能急速往下拖拽页面，此时，没必要渲染这些首屏模块。</p>
<p>非关键模块统一送到 <code>lazyQueue</code> 队列，没有基于将非关键模块加入到懒加载监控，这里有两个原因：</p>
<ul>
<li>一旦加入监控，程序滚动就需要对每个模块做计算判断，模块太多，这里可能存在性能损失</li>
<li>如果关键模块还没有加载好，非关键模块进入视窗就会开始渲染，这势必会影响关键模块的渲染</li>
</ul>
<p>那么，什么时候开始加载非关键模块呢？</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">var __lazyLoaded = false;</div><div class="line">function runLazyQueue() &#123;</div><div class="line">  if(__lazyLoaded) &#123;</div><div class="line">    return;</div><div class="line">  &#125;</div><div class="line">  __lazyLoaded = true;</div><div class="line">  $(window).detach(&quot;mousemove scroll mousedown touchstart touchmove keydown resize onload&quot;, runLazyQueue);</div><div class="line">  var module;</div><div class="line">  while (module = lazyQueue.shift()) &#123;</div><div class="line">    ~function(m)&#123;</div><div class="line">      // 保证在浏览器空闲时间处理 JS 程序, 保证不阻塞</div><div class="line">      window.requestNextAnimationFrame(function() &#123;</div><div class="line">        new Loader(m.$mod, m.data, m.force);</div><div class="line">      &#125;);</div><div class="line">    &#125;(module);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">$(window).on(&quot;mousemove scroll mousedown touchstart touchmove keydown resize onload&quot;, runLazyQueue);</div><div class="line">// 担心未触发 onload 事件, 5s 之后执行懒加载队列</div><div class="line">window.requestNextAnimationFrame(function() &#123;</div><div class="line">  runLazyQueue();</div><div class="line">&#125;, 5E3);</div></pre></td></tr></table></figure>
<p>上面的代码应该十分清晰，两种请求下会开始将非关键模块加入懒加载监控：</p>
<ul>
<li>当页面中触发 <code>mousemove scroll mousedown touchstart touchmove keydown resize onload</code> 这些事件的时候，说明用户开始与页面交互了，程序必须开始加载。</li>
<li>如果用户没有交互，但是页面已经 onload 了，程序当然不能浪费这个绝佳的空档机会，趁机加载内容；经测试，部分情况下，onload 事件没有触发（原因尚不知），所以还设定了一个超时加载，5s 之后，不论页面加载情况如何，都会将剩下的非关键模块加入到懒加载监控。</li>
</ul>
<h3 id="懒执行，有交互才执行"><a href="#懒执行，有交互才执行" class="headerlink" title="懒执行，有交互才执行"></a>懒执行，有交互才执行</h3><p>如果说上面的优化叫做懒加载，那么这里的优化可以称之为懒执行。</p>
<p>首页上有几个模块是包含交互的，如头条区域的 tab ，便民服务的浮层和主题市场的浮层，部分用户进入页面可能根本不会使用这些功能，所以<strong>程序上并没有对这些模块做彻底的初始化</strong>，而是等到用户 hover 到这个模块上再执行全部逻辑。</p>
<h3 id="更懒的执行，刷新页面才执行"><a href="#更懒的执行，刷新页面才执行" class="headerlink" title="更懒的执行，刷新页面才执行"></a>更懒的执行，刷新页面才执行</h3><p>首屏中有两个次要请求，一个是主题市场的 hot 标，将用户最常逛的三个类目打标；第二个是个人中心的背景，不同的城市会展示不同的背景图片，这里需要请求拿到城市信息。</p>
<p>这两处的渲染策略都是，在程序的 idle（空闲）时期，或者 <code>window.onload</code> 十秒之后去请求，然后将请求的结果缓存到本地，当用户第二次访问淘宝首页时能够看到效果。<strong>这是一种更懒的执行，用户刷新页面才看得到</strong>.这种优化是产品能够接受，也是技术上合理的优化手段。</p>
<h3 id="图片尺寸的控制和懒加载"><a href="#图片尺寸的控制和懒加载" class="headerlink" title="图片尺寸的控制和懒加载"></a>图片尺寸的控制和懒加载</h3><p>不论图片链接的来源是运营填写还是接口输出，都难以保证图片具备恰当的宽高，加上如今 retina 的屏幕越来越多，对于这种用户也要提供优质的视觉体验，图片这块的处理并不轻松。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&lt;img src=&apos;//g.alicdn.com/s.gif&apos; data-src=&apos;//g.alicdn.com/real/path/to/img.png&apos; /&gt;</div></pre></td></tr></table></figure>
<p>阿里 CDN 是支持对图片尺寸做压缩处理的，如下图为 200x200 尺寸的图片：</p>
<p><img src="https://img.alicdn.com/tps/TB1JZa9LVXXXXb3XFXXXXXXXXXX-200-200.gif" alt="200x200"></p>
<p>加上 <code>_100x100.jpg</code> 的参数后，会变成小尺寸：</p>
<p><img src="https://img.alicdn.com/tps/TB1JZa9LVXXXXb3XFXXXXXXXXXX-200-200.gif_100x100.jpg" alt="100x100"></p>
<p>我们知道 webp 格式的图片比对应的 jpg 要小三分之一，如上图加上 <code>_.webp</code> 参数后:</p>
<p><img src="https://img.alicdn.com/tps/TB1JZa9LVXXXXb3XFXXXXXXXXXX-200-200.gif_100x100.jpg_.webp" alt="100x100 webp"></p>
<p>视觉效果并没有什么折扣，但是图片体积缩小了三分之一，图片越大，节省的越明显。显然，淘宝首页的所有图片都做了如上的限制，针对坑位大小对图片做压缩处理，只是这里需要注意的是，运营填写的图片可能已经是压缩过的，如：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$img = &apos;//g.alicdn.com/real/path/to/img.png_400x400.jpg&apos;;</div><div class="line"></div><div class="line">&lt;img src=&apos;&#123;&#123;$img&#125;&#125;_100x100jpg_.webp&apos; /&gt;</div></pre></td></tr></table></figure>
<p>上面这种情况，图片是不会正确展示的。首页对所有的图片的懒加载都做了统一的函数处理：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">src = src.replace(/\s/g, &apos;&apos;);</div><div class="line">var arr;</div><div class="line">if (/(_\d&#123;2,&#125;x\d&#123;2,&#125;\w*?\.(?:jpg|png))&#123;2,&#125;/.test(src) &amp;&amp; src.indexOf(&apos;_!!&apos;) == -1) &#123;</div><div class="line">  arr = src.split(&apos;_&apos;);</div><div class="line">  if (arr[arr.length - 1] == &apos;.webp&apos;) &#123;</div><div class="line">    src = [arr[0], arr[arr.length - 2], arr[arr.length - 1]].join(&apos;_&apos;);</div><div class="line">  &#125; else &#123;</div><div class="line">    src = [arr[0], arr[arr.length - 1]].join(&apos;_&apos;);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">if (src.indexOf(&apos;_!!&apos;) &gt; -1) &#123;</div><div class="line">  src = src.replace(/((_\d&#123;2,&#125;x\d&#123;2,&#125;[\w\d]*?|_co0)\.(jpg|png))+/, &apos;$1&apos;);</div><div class="line">&#125;</div><div class="line">WebP.isSupport(function(isSupportWebp) &#123;</div><div class="line">  // https 协议访问存在问题 IE8，去 schema</div><div class="line">  if (/^http:/.test(src)) &#123;</div><div class="line">    src = src.slice(5);</div><div class="line">  &#125;</div><div class="line">  // 支持 webp 格式，并且 host 以 taobaocdn 和 alicdn 结尾，并且不是 s.gif 图片</div><div class="line">  if (isSupportWebp &amp;&amp; /(taobaocdn|alicdn)\.com/.test(src) &amp;&amp; (src.indexOf(&apos;.jpg&apos;) ||</div><div class="line">    src.indexOf(&apos;.png&apos;)) &amp;&amp; !/webp/.test(src) &amp;&amp; !ignoreWebP &amp;&amp; !/\/s\.gif$/.test(src)) &#123;</div><div class="line">    src += &apos;_.webp&apos;;</div><div class="line">  &#125;</div><div class="line">  $img.attr(&apos;src&apos;, src);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="模块去钩子，走配置"><a href="#模块去钩子，走配置" class="headerlink" title="模块去钩子，走配置"></a>模块去钩子，走配置</h3><p>TMS 的模块在输出的时候会将数据的 id 放在钩子上：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&lt;div class=&apos;J_Module&apos; tms-datakey=&apos;2483&apos;&gt;&lt;/div&gt;</div></pre></td></tr></table></figure>
<p>如果模块是异步展示的，可以通过 <code>tms-datakey</code> 找到模块数据，而首页的个性化是从几十上百个模块中通过算法选出几个，如果把这些模块钩子全部输出来，虽说取数据方便了很多，却存在大量的冗余，对此的优化策略是：将数据格式相同的模块单独拿出来，新建页面作为数据页。所以可以在源码中看到好几段这样的配置信息：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">&lt;textarea class=&quot;tb-hide&quot;&gt;[&#123;&quot;backup&quot;:&quot;false&quot;,&quot;baseid&quot;:&quot;1&quot;,&quot;mid&quot;:&quot;222726&quot;,&quot;name&quot;:&quot;iFashion&quot;,&quot;per&quot;:&quot;false&quot;,&quot;tid&quot;:&quot;3&quot;,&quot;uid&quot;:&quot;1000&quot;&#125;,&#123;&quot;backup&quot;:&quot;false&quot;,&quot;baseid&quot;:&quot;3&quot;,&quot;mid&quot;:&quot;222728&quot;,&quot;name&quot;:&quot;美妆秀&quot;,&quot;per&quot;:&quot;false&quot;,&quot;tid&quot;:&quot;3&quot;,&quot;uid&quot;:&quot;1001&quot;&#125;,&#123;&quot;backup&quot;:&quot;false&quot;,&quot;baseid&quot;:&quot;4&quot;,&quot;mid&quot;:&quot;222729&quot;,&quot;name&quot;:&quot;爱逛街&quot;,&quot;per&quot;:&quot;false&quot;,&quot;tid&quot;:&quot;4&quot;,&quot;uid&quot;:&quot;1002&quot;&#125;,&#123;&quot;backup&quot;:&quot;false&quot;,&quot;baseid&quot;:&quot;2&quot;,&quot;mid&quot;:&quot;222727&quot;,&quot;name&quot;:&quot;全球购&quot;,&quot;per&quot;:&quot;false&quot;,&quot;tid&quot;:&quot;4&quot;,&quot;uid&quot;:&quot;1003&quot;&#125;]&lt;/textarea&gt;</div></pre></td></tr></table></figure>
<p>减少了大量的源码以及对 DOM 的解析。</p>
<h3 id="低频修改模块，缓存请求"><a href="#低频修改模块，缓存请求" class="headerlink" title="低频修改模块，缓存请求"></a>低频修改模块，缓存请求</h3><p>有一些模块数据是很少被修改的，比如接口的兜底数据、阿里 APP 模块数据等，可以通过调整参数，设置模块的缓存时间，如：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">io(&#123;</div><div class="line">  url: URL,</div><div class="line">  dataType: &apos;jsonp&apos;,</div><div class="line">  cache: true,</div><div class="line">  jsonpCallback: &apos;jsonp&apos; + Math.floor(new Date / (1000 * 60)),</div><div class="line">  success: function() &#123;</div><div class="line">    //...</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><code>Math.floor(new Date / (1000 * 60))</code> 这个数值在一分钟内是不会发生变化的，也就是说将这个请求在本地缓存一分钟，对于低频修改模块，缓存时间可以设置为一天，即：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">Math.floor(new Date / (1000 * 60 * 60 * 24))</div></pre></td></tr></table></figure>
<p>当然，我们也可以采用本地储存的方式缓存这个模块数据：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">offline.setItem(&apos;cache-moduleName&apos;, JSON.stringify(data), 1000 * 60 * 60 * 24);</div></pre></td></tr></table></figure>
<p>缓存过期时间设置为 1 天，淘宝首页主要采用本地缓存的方式。</p>
<h4 id="使用缓动效果减少等待的焦急感"><a href="#使用缓动效果减少等待的焦急感" class="headerlink" title="使用缓动效果减少等待的焦急感"></a>使用缓动效果减少等待的焦急感</h4><p>这方面的优化不是很多，但是也有一点效果，很多模块的展示并不是干巴巴的<code>.show()</code>，而是通过动画效果，缓动呈现，这方面的优化推荐使用 CSS3 属性去控制，性能消耗会少很多。</p>
<h2 id="优化的思考角度"><a href="#优化的思考角度" class="headerlink" title="优化的思考角度"></a>优化的思考角度</h2><p>页面优化的切入点很多，我们不一定能够面面俱到，但是对于一个承载较大流量的页面来说，下面几条必须有效执行：</p>
<ul>
<li>首屏一定要快</li>
<li>滚屏一定要流畅</li>
<li>能不加载的先别加载</li>
<li>能不执行的先别执行</li>
<li>渐进展现、圆滑展现</li>
</ul>
<p>当然，性能优化的切入角度不仅仅是上几个方面，对照 Chrome 的 Timeline 柱状图和折线图，我们还可以找到很多优化的点，如：</p>
<p><img src="http://gtms02.alicdn.com/tps/i2/TB1qwc6LVXXXXcnXXXX5W.tKFXX-1818-1096.png" alt="淘宝首页 Chrome Timeline"></p>
<ul>
<li>在 1.0s 左右存在一次 painting 阻塞，可能因为一次性展示的模块面积过大</li>
<li>从 FPS 的柱状图可以看出，在 1.5s-2.0s 之间，存在几次 Render 和 JavaScript 丢帧</li>
<li>从多出的红点可以看出页面 jank 次数，也能够定位到代码堆栈</li>
</ul>
<p>在优化的过程中需要更多地思考，如何让阻塞的脚本分批执行，如何将长时间执行的脚本均匀地分配到时间线上。这些优化都体现在代码的细节上，宏观上的处理难以有明显的效果。当然，在宏观上，淘宝首页也有一个明显的优化：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">// https://gist.github.com/miksago/3035015#file-raf-js</div><div class="line">(function() &#123;</div><div class="line">  var lastTime = 0;</div><div class="line">  var vendors = [&apos;ms&apos;, &apos;moz&apos;, &apos;webkit&apos;, &apos;o&apos;];</div><div class="line">  for(var x = 0; x &lt; vendors.length &amp;&amp; !window.requestAnimationFrame; ++x) &#123;</div><div class="line">    window.requestAnimationFrame = window[vendors[x]+&apos;RequestAnimationFrame&apos;];</div><div class="line">    window.cancelAnimationFrame = window[vendors[x]+&apos;CancelAnimationFrame&apos;] || window[vendors[x]+&apos;CancelRequestAnimationFrame&apos;];</div><div class="line">  &#125;</div><div class="line">  if (!window.requestAnimationFrame) &#123;</div><div class="line">    window.requestAnimationFrame = function(callback, element) &#123;</div><div class="line">      var currTime = new Date().getTime();</div><div class="line">      var timeToCall = Math.max(0, 16 - (currTime - lastTime));</div><div class="line">      var id = window.setTimeout(function() &#123; callback(currTime + timeToCall); &#125;, timeToCall);</div><div class="line">      lastTime = currTime + timeToCall;</div><div class="line">      return id;</div><div class="line">    &#125;;</div><div class="line">  &#125;</div><div class="line">  if (!window.cancelAnimationFrame) &#123;</div><div class="line">    window.cancelAnimationFrame = function(id) &#123;</div><div class="line">      clearTimeout(id);</div><div class="line">    &#125;;</div><div class="line">  &#125;</div><div class="line">&#125;)();</div></pre></td></tr></table></figure>
<p>这段代码基本保证每个模块的初始化都是在浏览器空闲时期，减少了很多不必要的丢帧。这个优化也可以被应用到每个模块的细节代码之中，不过优化难度会更高。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>代码的性能优化是一个精细活，如果你要在一个庞大的未经优化的页面上做性能优化，可能会面临一次重构代码。本文从淘宝首页个性化引出的问题出发，从微观到宏观讲述了页面的优化实践，提出了几条可以借鉴的优化标准，希望对你有所启发。优化的细节点描述的不够完善也不够全面，但是都是值得去优化的方向。</p>

	
	
	
	
</div>
				
				

                <!-- Post Comments -->
                
                    


                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    
    <!-- Prev Nav -->
    
        <a href="/2017/01/21/汪汪，汪汪，和汪汪/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            新篇
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2017/01/21/火星救援/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>
        </div>
    </div>

				
				
					<!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay "></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored  sidebar-fixed-left" role="navigation">
	<div id="sidebar-main">
	    <!-- Sidebar Header -->
		<div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
    <i class="material-icons">clear_all</i>
    <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span></button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/me.jpeg" alt="wanglinzhizhi's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        wanglinzhizhi@hotmail.com
        <b class="caret"></b>
    </a>
</div>

		<!-- Sidebar Navigation  -->
		<ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
			
                <li>
                    <a href="#" target="_blank" title="Email Me">
						<i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    <li id="sidebar-first-li">
        <a href="/" target="_self">
            <i class="material-icons sidebar-material-icons">home</i>
             主页
        </a>
    </li>

    <!-- I'm Feeling Lucky -->
<!--
    <li class="dropdown">
        <a href="" target="_self">
            <i class="material-icons sidebar-material-icons">explore</i>
             sidebar.imlucky
        </a>
    </li>
-->

	
    <!-- Archives  -->
    <li class="dropdown">
        <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
            <i class="material-icons sidebar-material-icons">inbox</i>
             归档
            <b class="caret"></b>
        </a>
        <ul class="dropdown-menu">
            <li>
            <a class="sidebar_archives-link" href="/archives/2017/01/">January 2017<span class="sidebar_archives-count">72</span></a>
        </ul>
    </li>

    <!-- Divider -->
    <li class="divider"></li>


    <!-- Pages  -->
	
		<li>
			<a href="/tags" title="Tags">
				Tags
			</a>
		</li>
	
		<li>
			<a href="/gallery" title="Gallery">
				Gallery
			</a>
		</li>
	
		<li>
			<a href="/about" title="About">
				About
			</a>
		</li>
	

    <!-- Article Numebr  -->
    <li>
        <a href="/archives">
             文章总数
             <span class="sidebar-badge">72</span>
        </a>
    </li>
</ul>

		<!-- Sidebar Divider -->
		<div class="sidebar-divider"></div>

		<!-- Sidebar Footer -->
		<!-- 
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持。 :) 
-->

<!-- Theme Material -->
<a href="https://github.com/viosey/hexo-theme-material"  class="sidebar-footer-text-a" target="_blank">
	<div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
		主题 - Material
		<span class="sidebar-badge badge-circle">i</span>
	</div>
</a>

<!-- Help & Support -->
<!--
<a href="mailto:hiviosey@gmail.com" class="sidebar-footer-text-a">
    <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
		sidebar.help
		<span class="mdl-button__ripple-container">
			<span class="mdl-ripple"></span>
		</span>
	</div>
</a>
-->

<!-- Feedback -->
<!--
<a href="https://github.com/viosey/hexo-theme-material/issues" target="_blank" class="sidebar-footer-text-a">
    <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
         sidebar.feedback
                    <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span></div>
</a>
-->

<!-- Abount Theme -->
<!--
<a href="https://blog.viosey.com/index.php/Material.html" target="_blank" class="sidebar-footer-text-a">
    <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
         sidebar.about_theme
        <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span></div>
</a>-->

	</div>
    
    <!-- Sidebar Sponsor -->
    


</aside>

				
				
				
					<!-- Footer Top Button -->
					<div class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>
				
				
				<!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
	
	
		<!-- Paradox Footer Left Section -->
		<div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    
    
    
    <!-- Facebook -->
    
    
    
    <!-- Google + -->
    
    
    
    <!-- Weibo -->
    
    
    
    <!-- Instagram -->
    
    
    
    <!-- Tumblr -->
    
    
    
    <!-- Github -->
    
    <a href="https://github.com/wagnlinzh" target="view_window"><button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-github.png);">
        <span class="visuallyhidden">Github</span>
    </button></a>
    
</div>


		<!--Copyright-->
		<div id="copyright">Copyright&nbsp;©&nbsp;<script type="text/javascript">var fd = new Date();document.write(fd.getFullYear());</script>&nbsp;wanglinzhizhi</div>

		<!-- Paradox Footer Right Section -->

		<!-- 
		I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright.
		It will not impact the appearance and can give developers a lot of support :)

		很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
		它不会影响美观并可以给开发者很大的支持。 :) 
		-->

		<div class="mdl-mini-footer--right-section">
			<div>
				<div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
				<div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
			</div>
		</div>
	
    
</footer>
                
				<!-- Import File -->
<script src="/js/highlight.min.js"></script>
<script src="/js/js.min.js"></script>
<script src="/js/nprogress.js"></script>

<script type="text/javascript">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    
    $('#nprogress .bar').css({
        'background': '#FF4081'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #FF4081, 0 0 15px #FF4081'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#FF4081',
        'border-left-color': '#FF4081'
    });
    
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>


	<script src="/js/smoothscroll.js"></script>



    <!-- Leancloud -->
	<script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
	<script>
		AV.initialize("EObBAbqpQfNFLuV5SjbVgoxq-gzGzoHsz", "qPdmjfSU3DDmPPH9ui0cUW4z");
	</script>
    <script>
	function showTime(Counter) {
		var query = new AV.Query(Counter);
		$(".leancloud-views_num").each(function() {
			var url = $(this).attr("id").trim();
			query.equalTo("url", url);
			query.find({
				success: function(results) {
					if (results.length == 0) {
						var content = '0 ' + $(document.getElementById(url)).text();
						$(document.getElementById(url)).text(content);
						return;
					}
					for (var i = 0; i < results.length; i++) {
						var object = results[i];
						var content = object.get('time') + ' ' + $(document.getElementById(url)).text();
						$(document.getElementById(url)).text(content);
					}
				},
				error: function(object, error) {
					console.log("Error: " + error.code + " " + error.message);
				}
			});

		});
	}

	function addCount(Counter) {
		var Counter = AV.Object.extend("Counter");
		url = $(".leancloud-views_num").attr('id').trim();
		title = $(".leancloud-views_num").attr('data-flag-title').trim();
		var query = new AV.Query(Counter);
		query.equalTo("url", url);
		query.find({
			success: function(results) {
				if (results.length > 0) {
					var counter = results[0];
					counter.fetchWhenSave(true);
					counter.increment("time");
					counter.save(null, {
						success: function(counter) {
							var content =  counter.get('time') + ' ' + $(document.getElementById(url)).text();
							$(document.getElementById(url)).text(content);
						},
						error: function(counter, error) {
							console.log('Failed to save Visitor num, with error message: ' + error.message);
						}
					});
				} else {
					var newcounter = new Counter();
					newcounter.set("title", title);
					newcounter.set("url", url);
					newcounter.set("time", 1);
					newcounter.save(null, {
						success: function(newcounter) {
							console.log("newcounter.get('time')="+newcounter.get('time'));
							var content = newcounter.get('time') + ' ' + $(document.getElementById(url)).text();
							$(document.getElementById(url)).text(content);
						},
						error: function(newcounter, error) {
							console.log('Failed to create');
						}
					});
				}
			},
			error: function(error) {
				console.log('Error:' + error.code + " " + error.message);
			}
		});
	}
	$(function() {
		var Counter = AV.Object.extend("Counter");
		if ($('.leancloud-views_num').length == 1) {
			addCount(Counter);
		} else if ($('.post-title-link').length > 1) {
			showTime(Counter);
		}
	}); 
</script>








<!-- Swiftye -->


<!-- Local Search-->

	<script>
	var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        success: function( xmlResponse ) {
            // get the contents from search data
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var str='<ul class=\"search-result-list\">';                
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length <= 0) {
                    return;
                }
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = true;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = data.url;
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '' && data_content != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title < 0 && index_content < 0 ){
                                isMatch = false;
                            } else {
                                if (index_content < 0) {
                                    index_content = 0;
                                }
                                if (i == 0) {
                                    first_occur = index_content;
                                }
                            }
                        });
                    }
                    // show search results
                    if (isMatch) {
                        str += "<li><a href='"+ data_url +"' class='search-result-title' target='_blank'>"+ data_title;
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out characters
                            var start = first_occur - 6;
                            var end = first_occur + 6;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 10;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substr(start, end); 
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<em class=\"search-keyword\">"+keyword+"</em>");
                            })
                            str += "<p class=\"search-result\">" + match_content +"...</p>" +"</a>";
                        }
                    }
                })
                $resultContent.innerHTML = str;
            })
        }
    })
}
</script>

	<script>
        var inputArea = document.querySelector("#search");
        var getSearchFile = function(){
            var path = "search.xml";
            searchFunc(path, 'search', 'local-search-result');
        }

        inputArea.onfocus = function(){ getSearchFile() }
	</script>


<!-- Window Load-->
<script>
    $(window).load(function() {
        // Post_Toc parent position fixed
        $(".post-toc-wrap").parent(".mdl-menu__container").css("position", "fixed");
    });
</script>

<!-- MathJax Load-->

            </main>
        </div>
		
    </body>
		
	
</html>
